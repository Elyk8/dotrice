#!/bin/sh

for pid in $(pidof -x "sb-updater"); do
	if [ "$pid" != $$ ]; then
		echo "$(date +"%F %T"): sb-updater is already running with PID $pid, killing"
		kill "$pid"
	fi
done

# Add an artificial sleep to wait for the IPC handler to be ready to process requests
sleep 0.5

SETSTATUS="duskc --ignore-reply run_command setstatus"

# Top bar
$SETSTATUS 9 "$(sb-music)" &
$SETSTATUS 1 "$(sb-keymode)" &
killall pulseaudio-control; pulseaudio-control &
$SETSTATUS 3 "$(sb-microphone)" &
$SETSTATUS 4 "$(sb-brightness)" &
$SETSTATUS 8 "$(sb-pacpackages)" &

secs=0
while true; do

	# if [ $((secs % 5)) = 0 ]; then
	# 	$SETSTATUS 1 "$(sb-battery)" &
	# fi

	if [ $((secs % 30)) = 0 ]; then
		$SETSTATUS 0 "$(sb-clock)" &
	fi

	# if [ $((secs % 180)) = 0 ]; then
	# 	$SETSTATUS 4 "$(sb-mailbox)" &
	# fi

	if [ $((secs % 600)) = 0 ]; then
		$SETSTATUS 5 "$(sb-redshiftstatus)" &
		# $SETSTATUS 0 "$(sb-pacpackages)" &
	fi

	# if [ $((secs % 18000)) = 0 ]; then
	# 	$SETSTATUS 3 "$(sb-forecast)" &
	# fi

	secs=$((secs + 1))
	sleep 1
done
